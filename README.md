# Intro
This repository contains a set of useful scripts to interact with the PoolTogether v4 smart contracts. It contains a Python3 port of the [DrawCalculator NPM package](https://www.npmjs.com/package/@pooltogether/draw-calculator-js) and is meant to be used in combination with Brownie.

DISCLAIMER: Use of this set of scripts is at your own risk. I am in now way liable for any problems that arise due to using these scripts.

# Setup

## Install ganache

Install Ganache to use Brownie in combination with local deployments.

```
npm install -g ganache-cli
```

## Install dependencies

```
python3 -m pip install --user pipx
python3 -m pipx ensurepath
pipx install eth-brownie
pip3 install eth-abi
```

## Clone PoolTogether contracts

This is not technically necessary to run the scripts in this repository, but it's nice to have the contracts for future reference and you could deploy them on a local network to test new scripts.

```
mkdir contracts
cd contracts
git clone https://github.com/pooltogether/v4-core.git .
rm -r banner.png deploy hardhat hardhat.config.ts hardhat.network.ts helpers.ts LICENSE package.json README.md scripts templates test tsconfig.json yarn.lock
mv contracts/* .
rm -r contracts
cd ..
```

## Compile source

This step is only required if you want to deploy the contracts on a local network.

```
brownie compile
```

# Scripts

## Calculate prizes

First setup a .env file exporting an API key for Alchemy or Infura. Call the environment variable WEB3_ALCHEMY_PROJECT_ID or WEB3_INFURA_PROJECT_ID.

A fresh Brownie installation comes with preconfigured Infura networks. If you want to use Alchemy, you have to add them as below.

```
brownie networks list
brownie networks add Ethereum mainnet-alchemy chainid=1 host='https://eth-mainnet.alchemyapi.io/v2/{WEB3_ALCHEMY_PROJECT_ID}' name='Mainnet (Alchemy)'
brownie networks add Polygon polygon-mainnet-alchemy chainid=137 host='https://polygon-mainnet.g.alchemy.com/v2/${WEB3_ALCHEMY_PROJECT_ID}' name='Mainnet (Alchemy)'
```

The `calculate_prizes.py` script reads some configuration variables from an options JSON file. Sample JSON files have been included for Ethereum and Polygon where the prizes for all current holders for draws 1 to 16 are calculated. You can edit the `accounts` and `draw_ids` variables as you wish, there is no need to modify the contract addresses. You can run the script on a specific network using the following command:

```
brownie run scripts/calculate_prizes.py --network <network-name, e.g. polygon-mainnet-alchemy>
```

## Analyzing prizes

The `pretty_print_prizes.py` script will use a JSON prizes file generated by the `calculate_prizes.py` script and print an overview of all prizes won by a set of accounts over the analyzed draws.

```
python3 scripts/pretty_print_prizes.py --json <prizes-file>
```

## Plotting prizes

The `plot_prizes.py` script uses `matplotlib` to generate some basic plots for prizes that can be claimed by a set of accounts. Note that you need to have executed the `calculate_prizes.py` script first.

```
pip3 install matplotlib
python3 scripts/plot_prizes.py --json <prizes-file>
```

## Claim prizes

Assuming you have pre-calculated prizes for a(n) (set of) account(s) using the `calculate_prizes.py` script, the `claim_prizes.py` script allows to claim prizes for multiple draws in one transaction. Since this script will actually claim prizes, you need to supply an account. Brownie allows for different methods to achieve this, but personally I specify a `PRIVATE_KEY` environment variable in my .env file and load this through the `brownie-config.yaml` file.

```
brownie run scripts/claim_prizes.py --network <network-name, e.g. polygon-mainnet-alchemy>
```
